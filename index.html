<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Smart Parking Final</title>

<link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root{
  --primary:#6366f1;
  --success:#10b981;
  --danger:#ef4444;
  --bg:#f3f4f6;
}
body{
  margin:0;
  font-family:'Prompt',sans-serif;
  background:var(--bg);
  display:flex;
  justify-content:center;
  padding:20px;
}
.app{
  width:100%;
  max-width:550px;
  background:white;
  border-radius:20px;
  padding:20px;
  box-shadow:0 10px 30px rgba(0,0,0,0.1);
}
h1{text-align:center;margin-bottom:15px;}
.status{
  text-align:center;
  padding:12px;
  border-radius:12px;
  font-weight:600;
  margin-bottom:15px;
}
input{
  width:100%;
  padding:10px;
  border-radius:10px;
  border:1px solid #ddd;
  margin-bottom:10px;
}
button{
  width:100%;
  padding:10px;
  border:none;
  border-radius:10px;
  margin-bottom:10px;
  cursor:pointer;
  font-weight:600;
}
.btn-in{background:var(--success);color:white;}
.btn-out{background:var(--danger);color:white;}
.btn-admin{background:var(--primary);color:white;}
.hidden{display:none;}
.admin-box{
  background:#f9fafb;
  padding:15px;
  border-radius:15px;
  margin-top:15px;
  overflow-x:auto;
}
table{
  width:100%;
  border-collapse:collapse;
  font-size:12px;
}
th,td{
  padding:6px;
  border-bottom:1px solid #ddd;
  text-align:center;
}
th{background:#e5e7eb;}
.ticket{color:#6366f1;font-weight:bold;}
</style>
</head>

<body>
<div class="app">

<h1>üöó Smart Parking Final</h1>

<div id="status" class="status"></div>

<h3>üé´ ‡∏£‡∏±‡∏ö‡∏ö‡∏±‡∏ï‡∏£‡∏à‡∏≠‡∏î</h3>
<input type="text" id="plateIn" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏ñ">
<button class="btn-in" onclick="checkIn()">‡∏£‡∏±‡∏ö‡∏ö‡∏±‡∏ï‡∏£</button>

<h3>üö™ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏•‡∏≤‡∏ô</h3>
<input type="text" id="ticketOut" placeholder="‡∏Å‡∏£‡∏≠‡∏Å Ticket ID">
<button class="btn-out" onclick="checkOut()">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏á‡∏¥‡∏ô</button>

<hr>

<h3>üîê ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</h3>
<input type="password" id="adminPass" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô">
<button class="btn-admin" onclick="adminLogin()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>

<div id="adminPanel" class="hidden admin-box"></div>

</div>

<script>
const MAX_SLOT = 4;
const PRICE_PER_HOUR = 20;
const ADMIN_PASS = "admin123";
const N8N_URL = "PUT_YOUR_N8N_PRODUCTION_URL_HERE";

function getData(){
  return JSON.parse(localStorage.getItem("parkingLogs"))||[];
}
function saveData(data){
  localStorage.setItem("parkingLogs",JSON.stringify(data));
}

function updateStatus(){
  const active=getData().filter(d=>!d.time_out);
  const box=document.getElementById("status");

  if(active.length>=MAX_SLOT){
    box.style.background="#fee2e2";
    box.style.color="#991b1b";
    box.innerHTML="‚ùå ‡πÄ‡∏ï‡πá‡∏° ("+active.length+"/"+MAX_SLOT+")";
  }else{
    box.style.background="#ecfdf5";
    box.style.color="#065f46";
    box.innerHTML="‚úÖ ‡∏ß‡πà‡∏≤‡∏á "+(MAX_SLOT-active.length)+" ‡∏ä‡πà‡∏≠‡∏á";
  }
}

function generateTicket(){
  return "PK-"+Math.floor(10000+Math.random()*90000);
}

/* ‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤ */
function checkIn(){
  const plate=document.getElementById("plateIn").value.trim();
  if(!plate){alert("‡∏Å‡∏£‡∏≠‡∏Å‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô");return;}

  let data=getData();
  if(data.filter(d=>!d.time_out).length>=MAX_SLOT){
    alert("‡∏ó‡∏µ‡πà‡∏à‡∏≠‡∏î‡πÄ‡∏ï‡πá‡∏°");
    return;
  }

  const ticket=generateTicket();
  const timeIn=new Date().toISOString();

  data.push({
    plate:plate,
    ticket:ticket,
    time_in:timeIn,
    time_out:null,
    price:0
  });

  saveData(data);
  updateStatus();

  fetch(N8N_URL,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({
      type:"‡πÄ‡∏Ç‡πâ‡∏≤",
      plate:plate,
      ticket:ticket,
      time_in:timeIn
    })
  });

  alert("Ticket ID: "+ticket);
  document.getElementById("plateIn").value="";
}

/* ‡∏£‡∏ñ‡∏≠‡∏≠‡∏Å */
function checkOut(){
  const ticket=document.getElementById("ticketOut").value.trim();
  let data=getData();
  let record=data.find(d=>d.ticket===ticket && !d.time_out);
  if(!record){alert("‡πÑ‡∏°‡πà‡∏û‡∏ö Ticket");return;}

  const timeIn=new Date(record.time_in);
  const timeOut=new Date();
  const hours=Math.ceil((timeOut-timeIn)/3600000);
  const price=hours*PRICE_PER_HOUR;

  record.time_out=timeOut.toISOString();
  record.price=price;

  saveData(data);
  updateStatus();

  fetch(N8N_URL,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({
      type:"‡∏≠‡∏≠‡∏Å",
      plate:record.plate,
      ticket:ticket,
      price:price,
      time_out:record.time_out
    })
  });

  alert("‡∏Ñ‡πà‡∏≤‡∏à‡∏≠‡∏î "+price+" ‡∏ö‡∏≤‡∏ó");
  document.getElementById("ticketOut").value="";
}

/* ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô */
function adminLogin(){
  if(document.getElementById("adminPass").value!==ADMIN_PASS){
    alert("‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏¥‡∏î");return;
  }
  document.getElementById("adminPanel").classList.remove("hidden");
  loadReport();
}

function loadReport(){
  const data=getData();
  const finished=data.filter(d=>d.price>0);
  const active=data.filter(d=>!d.time_out);
  const total=finished.reduce((sum,d)=>sum+d.price,0);

  let html=`
  <h4>üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</h4>
  <p>üöó ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏≠‡∏î: ${active.length} ‡∏Ñ‡∏±‡∏ô | üí∞ ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏£‡∏ß‡∏°: ${total} ‡∏ö‡∏≤‡∏ó</p>
  <table>
    <tr>
      <th>‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</th>
      <th>Ticket (PK)</th>
      <th>‡πÄ‡∏Ç‡πâ‡∏≤</th>
      <th>‡∏≠‡∏≠‡∏Å</th>
      <th>‡∏£‡∏≤‡∏Ñ‡∏≤</th>
    </tr>
  `;

  data.forEach(d=>{
    html+=`
    <tr>
      <td>${d.plate}</td>
      <td class="ticket">${d.ticket}</td>
      <td>${d.time_in ? new Date(d.time_in).toLocaleString() : "-"}</td>
      <td>${d.time_out ? new Date(d.time_out).toLocaleString() : "-"}</td>
      <td>${d.price||0}</td>
    </tr>`;
  });

  html+=`</table><canvas id="revenueChart" style="margin-top:20px"></canvas>`;
  document.getElementById("adminPanel").innerHTML=html;

  const labels=finished.map((d,i)=>"‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ "+(i+1));
  const prices=finished.map(d=>d.price);

  new Chart(document.getElementById("revenueChart"),{
    type:"bar",
    data:{
      labels:labels,
      datasets:[{
        label:"‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ (‡∏ö‡∏≤‡∏ó)",
        data:prices,
        backgroundColor:"#6366f1"
      }]
    }
  });
}

updateStatus();
</script>

</body>
</html>
